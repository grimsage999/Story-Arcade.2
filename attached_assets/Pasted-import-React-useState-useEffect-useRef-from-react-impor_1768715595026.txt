import React, { useState, useEffect, useRef } from 'react';
import { Sparkles, MapPin, Rewind, Zap, ChevronRight, ChevronLeft, X, Share2, Info, RefreshCw, Star, Users, CheckCircle, Flame, TrendingDown, Eye, Crown, Handshake, BarChart3, Clock, Tag, Menu, Play, ArrowRight, Save, CornerDownLeft, Download, Bookmark, Shuffle, Trophy } from 'lucide-react';

/**
 * STORY ARCADE - PROTOTYPE v14 (DELIGHT & MICRO-INTERACTIONS)
 * TRACK 2: UNIQUE USE CASE (ALIF BUILD TOURNAMENT)
 * * UPDATES:
 * 1. "Juice" Added: Confetti, Ripples, Shakes, and Toasts.
 * 2. Easter Eggs: Special keywords trigger unique effects.
 * 3. Achievement System: "Story Streak" tracker.
 * 4. Micro-copy: Random motivational tooltips.
 */

// --- DATA & CONFIGURATION ---

const TRACKS = [
  {
    id: 'origin',
    title: 'Origin Story',
    subtitle: 'How did you become you?',
    description: "Trace the moment that defined your character arc. Every hero has a beginning.",
    icon: <Rewind className="w-6 h-6 text-fuchsia-400" />,
    color: 'from-fuchsia-500 to-purple-900',
    accent: 'text-fuchsia-400',
    border: 'border-fuchsia-500',
    badge: "CLASSIC",
    questions: [
      { id: 'hook', prompt: "Where were you when you realized your life was about to change?", placeholder: "e.g. On the roof...", guidance: "Set the scene." },
      { id: 'sensory', prompt: "Describe the sceneâ€”what specific sound, smell, or object defines that memory?", placeholder: "e.g. Rain on asphalt...", guidance: "Engage the senses." },
      { id: 'challenge', prompt: "What was the one obstacleâ€”a person, a fear, or a situationâ€”that stood in your way?", placeholder: "e.g. My own doubt.", guidance: "The antagonist." },
      { id: 'reflection', prompt: "In that moment of doubt, what was the one truth you told yourself?", placeholder: "e.g. 'I am ready.'", guidance: "Internal monologue." },
      { id: 'resolution', prompt: "How did overcoming that moment shape who you are today?", placeholder: "e.g. I open doors for others.", guidance: "Your power now." }
    ]
  },
  {
    id: 'future',
    title: 'Future NYC',
    subtitle: 'What does the city look like when we win?',
    description: "Step into 2036. Design the future your neighborhood deserves.",
    icon: <Zap className="w-6 h-6 text-cyan-400" />,
    color: 'from-cyan-400 to-blue-900',
    accent: 'text-cyan-400',
    border: 'border-cyan-400',
    badge: "POPULAR",
    questions: [
      { id: 'hook', prompt: "The year is 2036. What is the first thing that tells you 'We won'?", placeholder: "e.g. Silence of electric streets.", guidance: "Visualize victory." },
      { id: 'sensory', prompt: "Close your eyes. What is the new smell or sound in the air?", placeholder: "e.g. Jasmine scent.", guidance: "Make it tangible." },
      { id: 'challenge', prompt: "What was the specific problem the community had to solve together?", placeholder: "e.g. The heat waves.", guidance: "The struggle." },
      { id: 'reflection', prompt: "Why was it so important for you personally to see this change?", placeholder: "e.g. For my grandmother.", guidance: "Personal stake." },
      { id: 'resolution', prompt: "What is the new daily ritual that proves this future is here to stay?", placeholder: "e.g. Block dinners.", guidance: "Anchor in habit." }
    ]
  },
  {
    id: 'legend',
    title: 'Neighborhood Legend',
    subtitle: 'What is the myth your block will tell?',
    description: "Turn a local rumor into a timeless myth. Magic realism for the streets.",
    icon: <MapPin className="w-6 h-6 text-amber-400" />,
    color: 'from-amber-400 to-orange-900',
    accent: 'text-amber-400',
    border: 'border-amber-400',
    badge: "MYTHIC",
    questions: [
      { id: 'hook', prompt: "What is the strange or magical event that started the legend?", placeholder: "e.g. The talking cat.", guidance: "Inciting incident." },
      { id: 'sensory', prompt: "What was the one physical object at the center of it all?", placeholder: "e.g. The old oak tree.", guidance: "The artifact." },
      { id: 'challenge', prompt: "When the chaos started, how did the neighborhood almost fall apart?", placeholder: "e.g. Arguments over magic.", guidance: "The tension." },
      { id: 'reflection', prompt: "What was the secret reason the main character stepped up?", placeholder: "e.g. To share the magic.", guidance: "The 'Why'." },
      { id: 'resolution', prompt: "What is the one rule of reality that has changed forever?", placeholder: "e.g. No rain on weekends.", guidance: "The new world." }
    ]
  }
];

const MOTIVATIONS = [
  "You're building history.",
  "Keep it 100%.",
  "The future is yours to write.",
  "Your voice matters here.",
  "Cinema is waiting."
];

// --- UTILITIES ---

// Simple Confetti Canvas Component
const Confetti = ({ active }) => {
  const canvasRef = useRef(null);
  
  useEffect(() => {
    if (!active) return;
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    const particles = [];
    const colors = ['#22D3EE', '#E879F9', '#FBBF24', '#FFFFFF'];
    
    for (let i = 0; i < 100; i++) {
      particles.push({
        x: canvas.width / 2,
        y: canvas.height / 2,
        vx: (Math.random() - 0.5) * 20,
        vy: (Math.random() - 0.5) * 20,
        size: Math.random() * 5 + 2,
        color: colors[Math.floor(Math.random() * colors.length)],
        life: 100
      });
    }

    const animate = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let activeParticles = false;
      
      particles.forEach(p => {
        if (p.life > 0) {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.5; // Gravity
          p.life--;
          ctx.fillStyle = p.color;
          ctx.fillRect(p.x, p.y, p.size, p.size);
          activeParticles = true;
        }
      });
      
      if (activeParticles) requestAnimationFrame(animate);
    };
    
    animate();
  }, [active]);

  if (!active) return null;
  return <canvas ref={canvasRef} className="fixed inset-0 pointer-events-none z-[100]" />;
};


// --- COMPONENTS ---

const CRTOverlay = () => (
  <div className="pointer-events-none fixed inset-0 z-50 overflow-hidden h-full w-full opacity-50 md:opacity-80 mix-blend-overlay">
    <div className="absolute inset-0 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.1)_50%),linear-gradient(90deg,rgba(255,0,0,0.03),rgba(0,255,0,0.01),rgba(0,0,255,0.03))] bg-[length:100%_2px,3px_100%] pointer-events-none" />
    <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,transparent_50%,rgba(0,0,0,0.2)_100%)] pointer-events-none" />
  </div>
);

const ButtonPrimary = ({ children, onClick, disabled, className = "", tooltip }) => (
  <div className="group/btn relative">
    <button 
      onClick={(e) => {
        // Ripple effect
        const btn = e.currentTarget;
        const ripple = document.createElement("span");
        const rect = btn.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        ripple.style.width = ripple.style.height = `${size}px`;
        ripple.style.left = `${e.clientX - rect.left - size/2}px`;
        ripple.style.top = `${e.clientY - rect.top - size/2}px`;
        ripple.className = "absolute rounded-full bg-white/30 animate-ping pointer-events-none";
        btn.appendChild(ripple);
        setTimeout(() => ripple.remove(), 500);
        onClick && onClick(e);
      }}
      disabled={disabled}
      className={`relative overflow-hidden px-6 py-4 bg-cyan-400 text-black font-display font-bold uppercase tracking-widest text-sm md:text-base rounded-sm shadow-[0_0_15px_rgba(34,211,238,0.5)] hover:bg-white hover:shadow-[0_0_25px_rgba(255,255,255,0.6)] transition-all active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed ${className}`}
    >
      {children}
    </button>
    {tooltip && (
       <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-1 bg-black border border-cyan-500 text-cyan-400 text-[10px] font-mono whitespace-nowrap opacity-0 group-hover/btn:opacity-100 transition-opacity pointer-events-none z-50">
          {tooltip}
       </div>
    )}
  </div>
);

const ButtonSecondary = ({ children, onClick, className = "" }) => (
  <button 
    onClick={onClick}
    className={`px-6 py-4 border border-gray-700 bg-transparent text-gray-300 font-mono text-xs md:text-sm uppercase tracking-widest rounded-sm hover:border-gray-400 hover:text-white hover:bg-gray-900 transition-all active:bg-gray-800 ${className}`}
  >
    {children}
  </button>
);

const Navbar = ({ onViewChange, currentView, streak }) => {
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

  return (
    <nav className="fixed top-0 left-0 w-full z-40 bg-[#0F0F13]/90 backdrop-blur-xl border-b border-gray-800 px-4 md:px-8 py-4 flex justify-between items-center">
      <div 
        onClick={() => onViewChange('ATTRACT')} 
        className="cursor-pointer group flex items-center gap-3"
      >
        <div className="w-8 h-8 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-sm flex items-center justify-center shadow-lg shadow-cyan-900/50 group-hover:rotate-12 transition-transform">
          <Sparkles className="w-5 h-5 text-black fill-black" />
        </div>
        <span className="font-display text-lg md:text-xl text-white tracking-[0.15em] group-hover:text-cyan-400 transition-colors">STORY ARCADE</span>
      </div>
      
      <div className="hidden md:flex items-center gap-10 font-mono text-xs text-gray-500 font-medium tracking-widest">
        <button onClick={() => onViewChange('ATTRACT')} className={`hover:text-cyan-400 transition-colors ${currentView === 'ATTRACT' ? 'text-white' : ''}`}>HOME</button>
        <button onClick={() => onViewChange('GALLERY')} className={`hover:text-cyan-400 transition-colors ${currentView === 'GALLERY' ? 'text-white' : ''}`}>EXPLORE</button>
        <div className="flex items-center gap-1 text-amber-400 border border-amber-500/20 bg-amber-900/10 px-3 py-1 rounded-full" title="Stories Created">
           <Trophy className="w-3 h-3" /> {streak}
        </div>
      </div>

      <button 
        onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
        className="md:hidden text-gray-400 p-2 hover:text-white"
      >
        {mobileMenuOpen ? <X /> : <Menu />}
      </button>

      {mobileMenuOpen && (
        <div className="absolute top-full left-0 w-full bg-[#0F0F13] border-b border-gray-800 p-6 flex flex-col gap-6 md:hidden shadow-2xl animate-in slide-in-from-top-2">
          <button onClick={() => { onViewChange('ATTRACT'); setMobileMenuOpen(false); }} className="text-left text-white font-display text-xl tracking-widest">HOME</button>
          <button onClick={() => { onViewChange('GALLERY'); setMobileMenuOpen(false); }} className="text-left text-white font-display text-xl tracking-widest">EXPLORE</button>
          <button onClick={() => { onViewChange('TRACK_SELECT'); setMobileMenuOpen(false); }} className="text-left text-cyan-400 font-display text-xl tracking-widest">CREATE STORY</button>
        </div>
      )}
    </nav>
  );
};

// --- MAIN APPLICATION ---

export default function StoryArcade() {
  const [view, setView] = useState('ATTRACT'); 
  const [activeTrack, setActiveTrack] = useState(null);
  const [answers, setAnswers] = useState({});
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [generatedStory, setGeneratedStory] = useState(null);
  const [gallery, setGallery] = useState([]);
  const [galleryIndex, setGalleryIndex] = useState(0);
  const [loadingStep, setLoadingStep] = useState(0);
  const [demoCount, setDemoCount] = useState(0);
  const [galleryModalOpen, setGalleryModalOpen] = useState(false);
  
  // New States for "Juice"
  const [showConfetti, setShowConfetti] = useState(false);
  const [streak, setStreak] = useState(0);
  const [toast, setToast] = useState(null);
  const [inputError, setInputError] = useState(false);

  useEffect(() => {
    const saved = localStorage.getItem('story_arcade_gallery');
    const savedStreak = localStorage.getItem('story_arcade_streak');
    if (saved) setGallery(JSON.parse(saved));
    if (savedStreak) setStreak(parseInt(savedStreak));
    else {
      // Seed if empty
      const seeds = [{
          id: 1,
          trackId: "future",
          author: "Maria Elena",
          neighborhood: "Williamsburg",
          title: "The Evening Market Era",
          themes: ["Resilience", "Culture"],
          insight: "Vision of localized economy.",
          logline: "2036. The Williamsburg waterfront breathes again.",
          p1: "It starts with the silence of the electric streets...",
          p2: "The shift wasn't accidental...",
          p3: "Now, a new ritual anchors the day...",
          timestamp: new Date().toISOString(),
          trackTitle: "Future NYC"
      }];
      setGallery(seeds);
    }
  }, []);

  // --- ACTIONS ---

  const showToast = (msg) => {
    setToast(msg);
    setTimeout(() => setToast(null), 3000);
  };

  const handleTrackSelect = (track) => {
    setActiveTrack(track);
    setView('QUESTIONS');
    setCurrentQuestionIndex(0);
  };

  const handleAnswerChange = (text) => {
    const qId = activeTrack.questions[currentQuestionIndex].id;
    setAnswers(prev => ({ ...prev, [qId]: text }));
    setInputError(false);
  };

  const nextQuestion = () => {
    const currentQ = activeTrack.questions[currentQuestionIndex];
    if ((answers[currentQ.id] || '').length < 5) {
       setInputError(true); // Trigger shake
       return;
    }

    // Easter Egg Check
    if ((answers[currentQ.id] || '').toLowerCase().includes("isaiah")) {
       showToast("ðŸ”¥ EASTER EGG FOUND: Keep it 100%");
    }

    if (currentQuestionIndex < activeTrack.questions.length - 1) {
      setCurrentQuestionIndex(prev => prev + 1);
    } else {
      setShowConfetti(true);
      setTimeout(() => {
         setShowConfetti(false);
         generateStory();
      }, 2000);
    }
  };

  const prevQuestion = () => {
    if (currentQuestionIndex > 0) {
      setCurrentQuestionIndex(prev => prev - 1);
    } else {
      setView('TRACK_SELECT');
    }
  };

  const generateStory = async () => {
    setView('FORGING');
    setLoadingStep(0);
    const steps = [
       () => setLoadingStep(1),
       () => setLoadingStep(2),
       () => setLoadingStep(3),
       () => setLoadingStep(4)
    ];
    for (let i = 0; i < steps.length; i++) {
       await new Promise(r => setTimeout(r, 1000));
       steps[i]();
    }
    await new Promise(r => setTimeout(r, 500));

    // Mock Generators (Simplified for v14 brevity, assume same structure as v13)
    const storyContent = {
       title: "The Legend of " + (answers.hook ? answers.hook.slice(0, 10) : "Tomorrow"),
       themes: ["Hope", "Grit"],
       insight: MOTIVATIONS[Math.floor(Math.random() * MOTIVATIONS.length)],
       logline: "A new story begins today.",
       p1: "It started with " + (answers.hook || "a dream") + ".",
       p2: "Then came the challenge: " + (answers.challenge || "the doubt") + ".",
       p3: "But in the end, " + (answers.resolution || "victory was won") + ".",
       ...answers
    };

    const newStory = {
      id: Date.now(),
      trackId: activeTrack.id,
      ...storyContent,
      author: "Protagonist", 
      neighborhood: "The Block",
      timestamp: new Date().toISOString(),
      trackTitle: activeTrack.title
    };

    setGeneratedStory(newStory);
    const newGallery = [newStory, ...gallery].slice(0, 50);
    setGallery(newGallery);
    localStorage.setItem('story_arcade_gallery', JSON.stringify(newGallery));
    
    // Update Streak
    const newStreak = streak + 1;
    setStreak(newStreak);
    localStorage.setItem('story_arcade_streak', newStreak.toString());
    
    setView('REVEAL');
  };

  const handleSecretDemoTrigger = () => {
    const newCount = demoCount + 1;
    setDemoCount(newCount);
    if (newCount === 3) {
      setActiveTrack(TRACKS[1]); 
      setAnswers({
        hook: "The Williamsburg waterfront where art meets commerce",
        sensory: "The smell of cilantro and salt water",
        challenge: "No more food deserts",
        reflection: "Street vendors become small business owners",
        resolution: "The Evening Market ritual"
      });
      setTimeout(() => generateStory(), 500);
      setDemoCount(0);
    }
  };

  // --- VIEWS ---

  if (view === 'ATTRACT') {
    return (
      <div className="min-h-screen bg-[#0F0F13] flex flex-col font-sans text-white relative">
        <CRTOverlay />
        <Navbar onViewChange={setView} currentView={view} streak={streak} />
        
        <div className="relative flex-1 flex flex-col justify-center items-center px-6 text-center pt-20 md:pt-0">
           <div className="z-10 max-w-5xl space-y-8 animate-in fade-in zoom-in duration-1000">
              <div onClick={handleSecretDemoTrigger} className="inline-block px-4 py-1.5 border border-cyan-500/20 rounded-full bg-cyan-900/10 text-cyan-400 font-mono text-[10px] md:text-xs tracking-[0.2em] mb-4 backdrop-blur-sm hover:bg-cyan-900/20 transition-colors cursor-pointer">
                 COMMUNITY MYTHOLOGY ENGINE v1.0
              </div>
              <h1 className="text-5xl md:text-8xl font-display leading-[0.9] tracking-tight hover:scale-[1.01] transition-transform duration-500 cursor-default">
                 TURN YOUR STORY INTO <br />
                 <span className="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600 drop-shadow-[0_0_30px_rgba(34,211,238,0.4)] animate-pulse">
                    CINEMATIC LEGEND
                 </span>
              </h1>
              <p className="text-gray-400 text-sm md:text-xl max-w-2xl mx-auto leading-relaxed font-light">
                 Build the public archive of the future. Answer 5 questions and watch your neighborhood's story come to life in a stylized artifact.
              </p>
              
              <div className="flex flex-col md:flex-row w-full md:w-auto gap-4 pt-8 justify-center">
                 <ButtonPrimary onClick={() => setView('TRACK_SELECT')} className="w-full md:w-auto" tooltip="Start Here">
                    Create Your Story <ChevronRight className="inline-block ml-2 w-5 h-5 group-hover:translate-x-1 transition-transform" />
                 </ButtonPrimary>
                 <ButtonSecondary onClick={() => { setActiveTrack(TRACKS[0]); setView('QUESTIONS'); }} className="w-full md:w-auto">
                    Quick Start: Origin
                 </ButtonSecondary>
              </div>
           </div>
        </div>
        
        {/* Toast Notification */}
        {toast && (
           <div className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-white text-black px-6 py-3 rounded-full font-bold font-mono text-sm shadow-2xl animate-in slide-in-from-bottom-5 fade-in z-[100] flex items-center gap-2">
              <Sparkles className="w-4 h-4 text-amber-500" /> {toast}
           </div>
        )}
      </div>
    );
  }

  if (view === 'TRACK_SELECT') {
    return (
      <div className="min-h-screen bg-[#0F0F13] flex flex-col font-sans relative">
        <CRTOverlay />
        <Navbar onViewChange={setView} currentView={view} streak={streak} />
        
        <div className="flex-1 p-6 md:p-12 pt-28 max-w-7xl mx-auto w-full">
          <div className="mb-10 md:mb-16">
             <h2 className="text-3xl md:text-5xl text-white font-display uppercase mb-3">Select a Cartridge</h2>
             <p className="text-gray-500 font-mono text-xs md:text-sm tracking-widest">CHOOSE THE THEME OF YOUR NARRATIVE</p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
            {TRACKS.map(track => (
              <div 
                key={track.id}
                onClick={() => handleTrackSelect(track)}
                className={`group relative min-h-[220px] md:h-[360px] bg-[#141419] border border-gray-800 hover:${track.border} p-8 flex flex-col justify-between cursor-pointer transition-all duration-300 hover:-translate-y-2 hover:shadow-[0_0_40px_rgba(0,0,0,0.4)] overflow-hidden rounded-md active:scale-[0.98]`}
              >
                <div className={`absolute inset-0 bg-gradient-to-br ${track.color} opacity-0 group-hover:opacity-10 transition-opacity duration-500`} />
                <div className="relative z-10 flex flex-col h-full">
                  <div className="flex justify-between items-start mb-6">
                     <div className={`p-3 rounded-md bg-gray-900 border border-gray-700 shadow-inner group-hover:scale-110 transition-transform duration-300`}>{track.icon}</div>
                     {track.badge && <span className="px-2 py-1 bg-white/5 border border-white/10 text-[10px] font-mono text-white rounded-sm tracking-wider">{track.badge}</span>}
                  </div>
                  <div>
                     <h3 className="font-display text-2xl md:text-3xl text-white mb-3 leading-none group-hover:text-cyan-400 transition-colors">{track.title}</h3>
                     <p className="font-sans text-xs md:text-sm text-gray-400 leading-relaxed opacity-80 group-hover:opacity-100 transition-opacity">{track.description}</p>
                  </div>
                  <div className="mt-auto pt-6 border-t border-gray-800/50 flex items-center justify-between text-[10px] font-mono text-gray-500 group-hover:text-white transition-colors">
                     <span>5 QUESTIONS</span>
                     <span className="flex items-center">INSERT <ArrowRight className="w-3 h-3 ml-2 group-hover:translate-x-1 transition-transform" /></span>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  if (view === 'QUESTIONS') {
    const question = activeTrack.questions[currentQuestionIndex];
    const currentInput = answers[question.id] || '';
    const charCount = currentInput.length;
    const isValid = charCount > 5;
    
    return (
      <div className="min-h-screen bg-[#0F0F13] flex flex-col font-sans relative overflow-hidden">
        <CRTOverlay />
        <Confetti active={showConfetti} />
        <Navbar onViewChange={setView} currentView={view} streak={streak} />
        
        <div className="flex-1 flex flex-col pt-24 pb-32 px-6 md:p-12 max-w-6xl mx-auto w-full">
          
          {/* Progress Header */}
          <div className="w-full flex justify-between items-center mb-8 md:mb-16 border-b border-gray-800 pb-6">
             <div className="flex items-center gap-4">
                <span className={`px-3 py-1 border ${activeTrack.border} ${activeTrack.accent} bg-${activeTrack.accent.split('-')[1]}-900/10 rounded-sm text-[10px] font-mono uppercase tracking-widest`}>
                    {activeTrack.title}
                </span>
                <span className="text-gray-500 font-mono text-xs tracking-widest hidden md:inline">SCENE {currentQuestionIndex + 1}/{activeTrack.questions.length}</span>
             </div>
             <div className="flex gap-2">
               {activeTrack.questions.map((_, i) => (
                  <div key={i} className={`h-1.5 w-8 md:w-12 rounded-full transition-all duration-500 ${i <= currentQuestionIndex ? 'bg-cyan-400 shadow-[0_0_8px_rgba(34,211,238,0.6)]' : 'bg-gray-800'}`} />
               ))}
             </div>
          </div>

          <div className="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-16">
             {/* Question */}
             <div className="lg:col-span-5 flex flex-col justify-center">
                <h3 className="text-2xl md:text-5xl font-display text-white leading-[1.1] mb-6 md:mb-8 animate-in fade-in slide-in-from-left-4 duration-500">
                   {question.prompt}
                </h3>
                {question.guidance && (
                   <div className="flex items-start gap-3 p-4 bg-gray-900/50 border-l-2 border-gray-700 text-gray-400 text-xs md:text-sm italic font-serif">
                      <Info className="w-4 h-4 text-cyan-500 shrink-0 mt-0.5" />
                      <p>Director's Note: {question.guidance}</p>
                   </div>
                )}
             </div>

             {/* Input */}
             <div className="lg:col-span-7 flex flex-col">
                <div className={`relative group flex-1 ${inputError ? 'animate-shake' : ''}`}>
                   <div className={`absolute -inset-0.5 bg-gradient-to-r from-cyan-500 to-purple-600 rounded-lg blur opacity-0 group-focus-within:opacity-50 transition duration-500 ${isValid ? 'opacity-20' : ''}`}></div>
                   <textarea
                      value={currentInput}
                      onChange={(e) => handleAnswerChange(e.target.value)}
                      placeholder={question.placeholder}
                      className="relative w-full h-full bg-[#141419] border border-gray-700 text-white p-6 md:p-8 text-lg md:text-xl focus:border-cyan-500 focus:ring-0 outline-none rounded-md font-serif placeholder:text-gray-700 placeholder:italic resize-none min-h-[300px] shadow-inner"
                      autoFocus
                   />
                   {isValid && (
                      <div className="absolute bottom-6 right-6 text-green-400 animate-in fade-in zoom-in bg-black/50 rounded-full p-1 backdrop-blur-sm">
                         <CheckCircle className="w-6 h-6" />
                      </div>
                   )}
                </div>
                <div className="flex justify-between items-center mt-3 text-[10px] font-mono text-gray-500 tracking-wider">
                   <span>MIN 5 CHARS</span>
                   <span className={`${currentInput.length > 150 ? 'text-amber-400' : ''}`}>{currentInput.length} CHARS</span>
                </div>
             </div>
          </div>
        </div>

        {/* Mobile-Optimized Bottom Bar */}
        <div className="fixed bottom-0 left-0 w-full bg-[#0F0F13]/95 backdrop-blur-lg border-t border-gray-800 p-4 md:p-6 flex justify-between items-center z-50">
           <button onClick={prevQuestion} className="text-gray-500 hover:text-white text-xs md:text-sm font-mono tracking-widest px-6 py-4 transition-colors">BACK</button>
           <ButtonPrimary 
              onClick={nextQuestion}
              tooltip={isValid ? "Ready to forge!" : "Type more to continue"}
              className={`w-full md:w-auto md:min-w-[200px] ml-4 flex justify-center items-center gap-3 ${!isValid ? 'opacity-50 grayscale' : ''}`}
           >
              {currentQuestionIndex === activeTrack.questions.length - 1 ? 'FINISH & FORGE' : 'NEXT SCENE'}
              <ArrowRight className="w-5 h-5" />
           </ButtonPrimary>
        </div>
      </div>
    );
  }

  // --- FORGING (LOADING) ---
  if (view === 'FORGING') {
    const messages = ["GATHERING THREADS...", "WEAVING WISDOM...", "CRAFTING MOMENT...", "FINALIZING..."];
    return (
      <div className="min-h-screen bg-[#0F0F13] flex flex-col items-center justify-center relative font-sans p-6">
        <CRTOverlay />
        <div className="z-10 text-center space-y-12">
          <div className="relative">
             <div className="w-32 h-32 md:w-48 md:h-48 border-4 border-gray-800 rounded-full animate-[spin_8s_linear_infinite] border-t-cyan-500 border-r-purple-500 mx-auto" />
             <div className="absolute inset-0 flex items-center justify-center">
                <Sparkles className="w-12 h-12 text-white animate-pulse" />
             </div>
          </div>
          <div className="space-y-3">
             <h2 className="text-2xl md:text-4xl font-display text-white tracking-[0.15em] animate-pulse drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">
               {messages[loadingStep] || "FORGING..."}
             </h2>
             <p className="text-gray-500 font-mono text-xs tracking-widest">DO NOT TURN OFF CONSOLE</p>
          </div>
        </div>
      </div>
    );
  }

  // --- REVEAL (STORY CARD) ---
  if (view === 'REVEAL') {
    return (
      <div className="min-h-screen bg-[#0F0F13] flex items-center justify-center p-4 pt-24 pb-32 relative font-sans overflow-y-auto">
        <CRTOverlay />
        <Navbar onViewChange={setView} currentView={view} streak={streak} />
        <div className="absolute inset-0 bg-gradient-to-b from-[#1a1a2e] to-[#0f3d4d] opacity-40" />
        
        <div className="w-full max-w-[900px] bg-[#141419] border border-cyan-500/30 flex flex-col animate-in fade-in slide-in-from-bottom-12 duration-700 shadow-[0_0_60px_rgba(0,0,0,0.6)] rounded-md overflow-hidden">
          {/* Card Header */}
          <div className="p-4 md:p-6 border-b border-gray-800 bg-black/40 flex justify-between items-center backdrop-blur-sm">
             <div className="flex items-center gap-4">
                <div className={`p-2 rounded-sm border ${activeTrack.border} bg-gray-900`}>{activeTrack.icon}</div>
                <div>
                   <div className="text-[10px] text-gray-500 font-mono tracking-[0.2em]">ID: {generatedStory.id.toString().slice(-4)}</div>
                   <div className="text-sm font-bold text-white uppercase tracking-widest">{activeTrack.title}</div>
                </div>
             </div>
             <div className="hidden md:flex items-center gap-2 text-[10px] font-mono text-cyan-400 border border-cyan-900/50 px-2 py-1 rounded-full bg-cyan-900/10">
                <CheckCircle className="w-3 h-3" /> VERIFIED LEGEND
             </div>
          </div>

          <div className="flex flex-col md:flex-row">
             {/* Visuals */}
             <div className="md:w-1/3 bg-gray-900 border-b md:border-b-0 md:border-r border-gray-800 flex flex-col">
                <div className="h-48 md:h-64 w-full bg-cover bg-center opacity-80 mix-blend-luminosity hover:mix-blend-normal transition-all duration-700" style={{ backgroundImage: `url('https://images.unsplash.com/photo-1605218427306-6354db696feb?q=80&w=800')` }} />
                <div className="p-6 flex-1 bg-[#18181c]">
                   <h4 className="text-[10px] text-gray-500 font-mono mb-3 uppercase tracking-widest">Themes Detected</h4>
                   <div className="flex flex-wrap gap-2">
                      {generatedStory.themes.map(t => <span key={t} className="px-3 py-1.5 bg-gray-800 border border-gray-700 text-cyan-400 text-[10px] font-bold uppercase rounded-sm shadow-sm">{t}</span>)}
                   </div>
                   <div className="mt-8 pt-6 border-t border-gray-800">
                      <h4 className="text-[10px] text-gray-500 font-mono mb-2 uppercase tracking-widest">Next Step</h4>
                      <p className="text-xs text-gray-300 italic leading-relaxed">"{generatedStory.insight}"</p>
                   </div>
                </div>
             </div>

             {/* Story Text */}
             <div className="md:w-2/3 p-8 md:p-12 bg-[#0F0F13]">
                <h1 className="text-3xl md:text-5xl text-white font-display uppercase mb-6 leading-[0.9] tracking-wide">{generatedStory.title}</h1>
                <div className="flex items-center gap-3 text-amber-400 font-mono text-xs mb-8">
                   <Star className="w-4 h-4 fill-current" />
                   <span>STARRING {generatedStory.author.toUpperCase()}</span>
                </div>
                <div className="space-y-6 text-gray-300 font-serif text-lg md:text-xl leading-relaxed">
                   <p className="first-letter:text-5xl first-letter:font-bold first-letter:text-white first-letter:float-left first-letter:mr-3 first-letter:mt-[-6px]">{generatedStory.p1}</p>
                   <p>{generatedStory.p2}</p>
                   <p>{generatedStory.p3}</p>
                </div>
             </div>
          </div>

          {/* Footer Actions */}
          <div className="p-4 md:p-6 border-t border-gray-800 bg-[#141419] flex flex-col md:flex-row gap-4 justify-between items-center">
             <div className="text-[10px] font-mono text-gray-600 uppercase tracking-widest hidden md:block">Story Arcade v1.0 â€¢ {new Date().toLocaleDateString()}</div>
             <div className="flex gap-3 w-full md:w-auto">
               <button onClick={() => showToast('Saved to Archive!')} className="flex-1 md:flex-none flex items-center justify-center gap-2 px-6 py-3 bg-gray-800 hover:bg-gray-700 text-white text-xs uppercase font-mono rounded-sm tracking-wider transition-colors active:scale-95">
                  <Download className="w-4 h-4" /> Save
               </button>
               <button onClick={() => setView('TRACK_SELECT')} className="flex-1 md:flex-none flex items-center justify-center gap-2 px-6 py-3 bg-cyan-500 hover:bg-white hover:text-black text-black text-xs uppercase font-mono font-bold rounded-sm tracking-wider transition-colors shadow-[0_0_15px_rgba(6,182,212,0.4)] active:scale-95">
                  <RefreshCw className="w-4 h-4" /> New Story
               </button>
             </div>
          </div>
        </div>
        
        {/* Toast Notification */}
        {toast && (
           <div className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-white text-black px-6 py-3 rounded-full font-bold font-mono text-sm shadow-2xl animate-in slide-in-from-bottom-5 fade-in z-[100] flex items-center gap-2">
              <Sparkles className="w-4 h-4 text-amber-500" /> {toast}
           </div>
        )}
      </div>
    );
  }

  // --- GALLERY (Keep existing v11 code) ---
  if (view === 'GALLERY') {
      return (
          <div className="min-h-screen bg-[#0F0F13] p-4 pt-24 font-sans text-white text-center">
              <Navbar onViewChange={setView} currentView={view} streak={streak} />
              <div className="max-w-4xl mx-auto">
                <h1 className="text-3xl md:text-4xl font-display mb-2 text-white">COMMUNITY ARCHIVE</h1>
                <p className="text-gray-500 font-mono text-xs tracking-widest mb-12">COLLECTING MYTHOLOGIES...</p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {gallery.map(s => (
                        <div key={s.id} onClick={() => { setGeneratedStory(s); setView('REVEAL'); }} className="p-6 bg-[#141419] border border-gray-800 hover:border-cyan-500/50 text-left cursor-pointer transition-all hover:-translate-y-1 group rounded-md">
                            <div className="flex justify-between items-start mb-4">
                               <div className="text-cyan-400 font-mono text-[10px] tracking-widest uppercase border border-cyan-900/50 px-2 py-1 rounded-sm bg-cyan-900/10">{s.trackTitle}</div>
                               <div className="text-gray-600 text-[10px] font-mono">{new Date(s.timestamp).toLocaleDateString()}</div>
                            </div>
                            <div className="text-xl font-display text-white mb-2 group-hover:text-cyan-400 transition-colors">{s.title}</div>
                            <div className="text-gray-400 text-sm font-serif line-clamp-2">"{s.logline}"</div>
                        </div>
                    ))}
                </div>
              </div>
          </div>
      )
  }

  return null;
}